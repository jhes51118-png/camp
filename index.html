<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>華碩志工社 2026 智慧媒合與數據分析 (B表單精確版)</title>
    
    <!-- 工具庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .asus-blue { color: #005696; }
        .bg-asus-blue { background-color: #005696; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-1px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .drop-zone.dragover { border-color: #005696; background-color: #e0f2fe; }
        .tab-btn { padding: 10px 20px; font-weight: bold; color: #6b7280; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-btn.active { color: #005696; border-bottom-color: #005696; }
        .allocation-list { transition: max-height 0.3s ease-out; overflow: hidden; max-height: 0; }
        .allocation-list.open { max-height: 500px; overflow-y: auto; }
        .table-container { max-height: 500px; overflow-y: auto; }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #f3f4f6; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        /* 狀態標籤樣式 */
        .badge-success { background-color: #d1fae5; color: #065f46; font-weight: bold; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; display: inline-block; margin-bottom: 2px;}
        .badge-fail { background-color: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; display: inline-block; margin-bottom: 2px; text-decoration: line-through;}
        .badge-info { background-color: #eff6ff; color: #1d4ed8; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; display: inline-block; margin-bottom: 2px;}
    </style>
</head>
<body>

    <nav class="bg-asus-blue text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-hand-holding-heart text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">華碩志工社 (2026 B表單專屬版)</h1>
                    <p class="text-xs text-blue-200">第一志願優先分發系統</p>
                </div>
            </div>
            <div class="flex gap-4">
                 <button onclick="document.getElementById('fileInput').click()" class="text-sm bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded transition shadow">
                    <i class="fa-solid fa-folder-open mr-1"></i> 重新匯入資料
                </button>
                <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" class="hidden" onchange="handleMainFile(this.files)">
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-6">

        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-lg px-4 shadow-sm">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active">
                <i class="fa-solid fa-chart-pie mr-2"></i>數據儀表板
            </button>
            <button onclick="switchTab('matching')" id="tab-matching" class="tab-btn">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>智慧志願媒合 (優先制)
            </button>
        </div>

        <div id="upload-prompt" class="card p-12 text-center drop-zone cursor-pointer mb-8" onclick="document.getElementById('fileInput').click()">
            <div class="text-gray-400 mb-4"><i class="fa-solid fa-cloud-arrow-up text-6xl"></i></div>
            <h2 class="text-2xl font-bold text-gray-700 mb-2">請匯入 2026 最新版 (B.xlsx) 報名表</h2>
            <p class="text-gray-500">系統將優先保障「第一志願」填寫者，並依據新版權重分配</p>
        </div>

        <!-- TAB 1: 數據儀表板 -->
        <div id="view-dashboard" class="hidden space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6 border-l-4 border-blue-600">
                    <p class="text-gray-500 text-sm font-medium">總報名人數</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1" id="kpi-people">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-green-500">
                    <p class="text-gray-500 text-sm font-medium">營隊總勾選人次</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1" id="kpi-slots">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-purple-500">
                    <p class="text-gray-500 text-sm font-medium">人均報名場次</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1" id="kpi-avg">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-orange-500">
                    <p class="text-gray-500 text-sm font-medium">第一志願填寫率</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-1" id="kpi-first">0%</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="card p-6">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">各梯次報名熱度 (勾選「是」的人數)</h3>
                    <div class="h-64"><canvas id="chart-camps"></canvas></div>
                </div>
                <div class="card p-6">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">志工經驗分佈</h3>
                    <div class="h-64 flex justify-center"><canvas id="chart-experience"></canvas></div>
                </div>
            </div>
            
            <div class="card p-0 overflow-hidden">
                <div class="p-4 bg-gray-50 border-b flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h3 class="font-bold text-gray-700">最新志工清單 (匯入資料預覽)</h3>
                        <span class="text-xs text-gray-400">顯示所有人，包含報名細項</span>
                    </div>
                    <!-- 新增：儀表板清單搜尋 -->
                    <div class="relative w-full sm:w-64">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                        </div>
                        <input type="text" id="searchVolunteerInput" onkeyup="filterVolunteerList()" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2" placeholder="搜尋姓名...">
                    </div>
                </div>
                <div class="table-container">
                    <table class="w-full text-sm text-left">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50">#</th>
                                <th class="px-6 py-3 bg-gray-50">姓名</th>
                                <th class="px-6 py-3 bg-gray-50 w-1/3">報名梯次 (勾選項目)</th>
                                <th class="px-6 py-3 bg-gray-50 w-1/3">第一志願</th>
                            </tr>
                        </thead>
                        <tbody id="table-top-list" class="bg-white divide-y divide-gray-200">
                            <!-- JS 生成結果 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB 2: 智慧志願媒合 -->
        <div id="view-matching" class="hidden space-y-6">
            
            <div class="card p-6 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800"><i class="fa-solid fa-sliders mr-2 text-blue-600"></i>參數設定</h2>
                        <p class="text-sm text-gray-500 mt-1">邏輯：第一志願優先錄取 > 權重分數排序。已加入「課程開發」權重。</p>
                    </div>
                    <div class="flex gap-2 mt-4 md:mt-0">
                        <button onclick="exportSettings()" class="bg-white border border-gray-300 text-gray-700 px-3 py-2 rounded hover:bg-gray-50 text-sm transition shadow-sm">
                            <i class="fa-solid fa-file-export mr-1"></i> 匯出設定
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- 權重設定 -->
                    <div>
                        <h3 class="font-bold text-gray-700 mb-3 border-b border-gray-200 pb-1">加權分數調整</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-sm" id="weights-display">
                            <!-- JS 動態生成一般權重 -->
                        </div>
                        
                        <!-- 獨立的報名時間設定區 -->
                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <h4 class="text-sm font-bold text-indigo-700 mb-2 flex items-center">
                                <i class="fa-regular fa-clock mr-1"></i> 報名時間加權 (早中晚鳥)
                            </h4>
                            <div class="grid grid-cols-3 gap-3 text-sm" id="time-weights-display">
                                <!-- JS 動態生成時間權重 -->
                            </div>
                        </div>
                    </div>
                    <!-- 名額設定與老手比例 -->
                    <div class="flex flex-col">
                        
                        <!-- 新增功能：多日營隊錄取次數上限設定 -->
                        <div class="bg-purple-50 border border-purple-100 p-4 rounded-lg mb-6">
                            <h3 class="font-bold text-purple-800 mb-3 border-b border-purple-200 pb-1 flex items-center">
                                <i class="fa-solid fa-user-gear mr-2"></i>多日營隊 錄取次數上限設定
                            </h3>
                            <div class="grid grid-cols-1 gap-3">
                                <div class="flex justify-between items-center bg-white p-2 rounded border border-purple-100">
                                    <span class="text-sm text-gray-700 font-medium">新手 (第一次參加)</span>
                                    <input type="number" id="limit-newbie" value="2" min="1" max="10" class="w-16 border border-purple-300 rounded px-1 py-1 text-center text-purple-700 font-bold outline-none">
                                </div>
                                <div class="flex justify-between items-center bg-white p-2 rounded border border-purple-100">
                                    <span class="text-sm text-gray-700 font-medium">老手 - 華碩員工</span>
                                    <input type="number" id="limit-asus-vet" value="2" min="1" max="10" class="w-16 border border-purple-300 rounded px-1 py-1 text-center text-purple-700 font-bold outline-none">
                                </div>
                                <div class="flex justify-between items-center bg-white p-2 rounded border border-purple-100">
                                    <span class="text-sm text-gray-700 font-medium">老手 - 非員工 (畢業生/眷屬等)</span>
                                    <input type="number" id="limit-non-asus-vet" value="2" min="1" max="10" class="w-16 border border-purple-300 rounded px-1 py-1 text-center text-purple-700 font-bold outline-none">
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-3 border-b border-gray-200 pb-1">
                            <h3 class="font-bold text-gray-700">各梯次名額上限 & 老手比例</h3>
                            <div class="flex items-center gap-2">
                                <label class="text-xs font-bold text-indigo-700 bg-indigo-100 px-2 py-1 rounded">老手保障比例 (%)</label>
                                <input type="number" id="veteran-ratio-input" value="50" min="0" max="100" class="w-16 border border-indigo-300 rounded px-1 py-1 text-center text-indigo-700 font-bold outline-none" title="設定每個梯次保留給老手(參加2年以上經驗)的名額比例">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-2 text-sm max-h-[250px] overflow-y-auto pr-2" id="capacities-display">
                            <!-- JS 動態生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center my-6">
                <button type="button" onclick="runMatching()" class="bg-green-600 text-white px-8 py-3 rounded-full text-lg font-bold shadow-lg hover:bg-green-500 transition transform hover:scale-105 active:scale-95 cursor-pointer">
                    <i class="fa-solid fa-calculator mr-2"></i> 執行優先分發 (第一志願優先)
                </button>
            </div>

            <!-- 分發清單區塊 (新增詳細資料) -->
            <div id="matching-results-container" class="hidden card p-0 overflow-hidden mb-8">
                <div class="p-4 bg-gray-50 border-b flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h3 class="font-bold text-gray-800"><i class="fa-solid fa-list-check mr-2 text-green-600"></i>分發詳細清單 (依分數排序)</h3>
                    
                    <div class="flex items-center gap-3 w-full sm:w-auto">
                        <!-- 搜尋框 -->
                        <div class="relative w-full sm:w-64">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
                            </div>
                            <input type="text" id="searchInput" onkeyup="filterMatchingResults()" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2" placeholder="搜尋姓名或標籤...">
                        </div>

                        <button onclick="exportMatchingResults()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm hover:bg-gray-700 transition whitespace-nowrap shadow">
                            <i class="fa-solid fa-file-export mr-1"></i> 匯出總表
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="w-full text-sm text-left">
                        <thead>
                            <tr>
                                <th class="px-4 py-3 bg-gray-50">#</th>
                                <th class="px-4 py-3 bg-gray-50">姓名</th>
                                <th class="px-4 py-3 bg-gray-50">身份/總分</th>
                                <th class="px-4 py-3 bg-gray-50 w-1/4">第一志願</th>
                                <th class="px-4 py-3 bg-gray-50 w-1/4">錄取梯次</th>
                                <th class="px-4 py-3 bg-gray-50 w-1/4 text-gray-500">落選/候補</th>
                            </tr>
                        </thead>
                        <tbody id="table-matching-list" class="bg-white divide-y divide-gray-200">
                            <!-- JS 生成結果 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 分配總覽區塊 -->
            <div id="allocation-results-container" class="hidden space-y-6">
                <div class="card p-6 bg-white border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                        <i class="fa-solid fa-campground mr-2 text-indigo-600"></i>多日營隊分配總覽
                    </h3>
                    <div id="allocation-grid-multi" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div class="card p-6 bg-white border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                        <i class="fa-solid fa-sun mr-2 text-orange-500"></i>一日營隊分配總覽
                    </h3>
                    <div id="allocation-grid-single" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                 <div class="card p-6 bg-red-50 border border-red-100">
                    <h3 class="text-xl font-bold text-red-800 mb-4 border-b border-red-200 pb-2">
                        <i class="fa-solid fa-user-xmark mr-2"></i>未錄取 / 候補名單
                    </h3>
                    <div id="allocation-grid-rejected" class="grid grid-cols-1 gap-6"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- 志工詳細資料 Modal -->
    <div id="volunteer-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closeVolunteerModal()"></div>
        <div class="bg-white w-full max-w-lg mx-4 rounded-lg shadow-2xl z-10 transform scale-95 transition-transform duration-300 flex flex-col max-h-[90vh]">
            <div class="bg-asus-blue text-white px-6 py-4 rounded-t-lg flex justify-between items-center">
                <h3 class="text-xl font-bold" id="modal-name">志工姓名</h3>
                <button onclick="closeVolunteerModal()" class="text-white hover:text-gray-200 focus:outline-none"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-4"><span id="modal-tags" class="text-sm font-bold text-indigo-600 bg-indigo-100 px-2 py-1 rounded"></span></div>
                <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                    <div><p class="text-gray-500 mb-1">Email</p><p id="modal-email" class="font-bold text-gray-800 break-all">-</p></div>
                    <div><p class="text-gray-500 mb-1">經驗年資</p><p id="modal-exp" class="font-bold text-gray-800">-</p></div>
                    <div class="col-span-2"><p class="text-gray-500 mb-1">專長或興趣</p><p id="modal-skills" class="font-bold text-gray-800">-</p></div>
                    <div class="col-span-2"><p class="text-gray-500 mb-1">第一志願</p><p id="modal-first-choice" class="font-bold text-blue-700">-</p></div>
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center"><i class="fa-solid fa-clipboard-list mr-2"></i> 所有報名梯次</h4>
                    <ul id="modal-camps-list" class="space-y-2 text-sm"></ul>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-3 rounded-b-lg flex justify-end">
                <button onclick="closeVolunteerModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">關閉</button>
            </div>
        </div>
    </div>

    <!-- JavaScript 邏輯核心 -->
    <script>
        let globalVolunteers = [];
        let CONFIG = { CAMPS: [] };
        let CAMP_DAYS = {};
        
        let globalWeights = {
            "2.一日營加分(每場)": 20,
            "4.畢業生/和碩生": 20,      
            "5.課程開發組": 20,         
            "早鳥(前33%)": 30,
            "中鳥(中33%)": 15,
            "晚鳥(後34%)": 0
        };

        let globalCapacities = {};
        let volunteerAssignmentsMap = {};
        let lastMatchingDataForSearch = []; 

        function detectColumns(headers) {
            CONFIG.TIMESTAMP = headers.find(h => h.includes("完成時間") || h.includes("提交時間") || h.includes("Timestamp")) || headers[2];
            CONFIG.NAME = headers.find(h => h.includes("姓名") && !h.includes("緊急")) || headers[6];
            CONFIG.EMAIL = headers.find(h => h.includes("電子郵件")) || headers[3];
            CONFIG.EXPERIENCE = headers.find(h => h.includes("曾參加過")) || headers[13];
            CONFIG.SKILLS = headers.find(h => h.includes("專長或興趣")) || headers[14];
            CONFIG.FIRST_CHOICE = headers.find(h => h.includes("第一志願") || h.includes("最希望") || h.includes("優先"));
            CONFIG.COURSE_DEV = headers.find(h => h.includes("課程開發") || h.includes("我有參予"));
            
            CONFIG.CAMPS = headers.filter(h => h.includes("是否參加") && h.includes("樂學營") && !h.includes("曾參加過"));
            
            CONFIG.CAMPS.forEach(camp => {
                if (camp.includes("一日")) CAMP_DAYS[camp] = 1;
                else if (camp.includes("二日") || camp.includes("兩日") || camp.includes("2日") || camp.includes("龜山") || camp.includes("大橋")) CAMP_DAYS[camp] = 2;
                else if (camp.includes("三日") || camp.includes("3日")) CAMP_DAYS[camp] = 3;
                else if (camp.includes("四日") || camp.includes("4日")) CAMP_DAYS[camp] = 4;
                else CAMP_DAYS[camp] = 1;

                if (!globalCapacities[camp]) {
                    globalCapacities[camp] = 25;
                }
            });
        }

        function shortCampName(longName) {
            let dateStr = "";
            let rangeDateMatch = longName.match(/(\d{4}\/\d{1,2}\/\d{1,2})[\s~]*(\d{1,2}\/\d{1,2})/); 
            if (rangeDateMatch) {
                let start = rangeDateMatch[1].replace(/^\d{2}(\d{2})/, "$1"); 
                let end = rangeDateMatch[2]; 
                dateStr = `${start}~${end}`;
            } else {
                let singleDateMatch = longName.match(/(\d{4}\/\d{1,2}\/\d{1,2})/);
                if (singleDateMatch) {
                    dateStr = singleDateMatch[1].replace(/^\d{2}(\d{2})/, "$1");
                }
            }

            let schoolStr = longName;
            schoolStr = schoolStr.replace(/是否參加|202\d\/\d{1,2}\/\d{1,2}[\s~]*(\d{1,2}\/\d{1,2})?|（.*?）|\(.*?\)/g, "");
            schoolStr = schoolStr.replace(/一日樂學營|二日樂學營|三日樂學營|四日樂學營|樂學營|一日營|營隊|國小/g, "");
            
            return `${dateStr}${schoolStr.trim()}`;
        }

        function handleMainFile(files) {
            if (files.length === 0) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {defval: ""});
                    
                    if (jsonData.length === 0) throw new Error("檔案為空");

                    const normalizedData = jsonData.map(row => {
                        const newRow = {};
                        Object.keys(row).forEach(key => newRow[key.trim()] = row[key]);
                        return newRow;
                    });

                    detectColumns(Object.keys(normalizedData[0]));
                    globalVolunteers = normalizedData.filter(row => {
                        const name = row[CONFIG.NAME];
                        return name && String(name).trim() !== "" && !String(name).includes("ex:王大明");
                    });

                    updateDashboard(globalVolunteers);
                    renderSettings();
                    
                    document.getElementById('upload-prompt').classList.add('hidden');
                    document.getElementById('view-dashboard').classList.remove('hidden');
                } catch (err) {
                    alert("讀取檔案失敗：" + err.message);
                }
            };
            reader.readAsArrayBuffer(files[0]);
        }

        function updateDashboard(volunteers) {
            let totalSlots = 0, newbie = 0, veteran = 0, firstChoiceFilled = 0;
            let campCounts = {}, expCounts = {};
            CONFIG.CAMPS.forEach(c => campCounts[c] = 0);

            volunteers.forEach(p => {
                CONFIG.CAMPS.forEach(c => {
                    const val = String(p[c]).trim();
                    if (val === "是" || val.toLowerCase() === "true" || val === "v") {
                        campCounts[c]++;
                        totalSlots++;
                    }
                });
                if (CONFIG.FIRST_CHOICE && p[CONFIG.FIRST_CHOICE] && String(p[CONFIG.FIRST_CHOICE]).trim() !== "") firstChoiceFilled++;
                let exp = String(p[CONFIG.EXPERIENCE] || "未填寫").trim();
                expCounts[exp] = (expCounts[exp] || 0) + 1;
                if (exp.includes("未曾參加") || exp.includes("無") || exp.includes("1~2年") || exp === "1年" || exp.includes("未填寫")) newbie++;
                else veteran++;
            });

            document.getElementById('kpi-people').innerText = volunteers.length;
            document.getElementById('kpi-slots').innerText = totalSlots;
            document.getElementById('kpi-avg').innerText = volunteers.length ? (totalSlots/volunteers.length).toFixed(1) : 0;
            document.getElementById('kpi-first').innerText = volunteers.length ? Math.round((firstChoiceFilled/volunteers.length)*100) + "%" : "0%";

            renderCharts(campCounts, expCounts);
            renderVolunteerList(volunteers);
        }

        // 新增：儀表板清單搜尋功能
        function filterVolunteerList() {
            const input = document.getElementById('searchVolunteerInput').value.toLowerCase();
            const filtered = globalVolunteers.filter(p => {
                const name = String(p[CONFIG.NAME] || "").toLowerCase();
                return name.includes(input);
            });
            renderVolunteerList(filtered);
        }

        function renderSettings() {
            const wContainer = document.getElementById('weights-display');
            wContainer.innerHTML = '';
            
            Object.entries(globalWeights).forEach(([key, val]) => {
                if (key.includes("早鳥") || key.includes("中鳥") || key.includes("晚鳥")) return;
                
                wContainer.innerHTML += `
                    <div class="bg-gray-50 p-2 rounded border border-gray-200 flex flex-col">
                        <label class="text-xs text-gray-500 font-bold mb-1">${key}</label>
                        <input type="number" value="${val}" onchange="globalWeights['${key}'] = Number(this.value)"
                            class="w-full border border-gray-300 rounded px-2 py-1 text-blue-800 font-bold outline-none">
                    </div>
                `;
            });

            const tContainer = document.getElementById('time-weights-display');
            tContainer.innerHTML = '';
            ["早鳥(前33%)", "中鳥(中33%)", "晚鳥(後34%)"].forEach(key => {
                let val = globalWeights[key] || 0;
                tContainer.innerHTML += `
                    <div class="bg-orange-50 p-2 rounded border border-orange-200 flex flex-col">
                        <label class="text-xs text-orange-800 font-bold mb-1">${key.split('(')[0]}</label>
                        <input type="number" value="${val}" onchange="globalWeights['${key}'] = Number(this.value)"
                            class="w-full border border-orange-300 rounded px-2 py-1 text-orange-800 font-bold outline-none">
                    </div>
                `;
            });

            const cContainer = document.getElementById('capacities-display');
            cContainer.innerHTML = '';
            Object.entries(globalCapacities).forEach(([camp, val]) => {
                cContainer.innerHTML += `
                    <div class="flex items-center justify-between bg-gray-50 p-2 mb-1 rounded border border-gray-200">
                        <span class="text-xs text-gray-700 font-medium truncate w-3/4" title="${camp}">${shortCampName(camp)}</span>
                        <div class="flex items-center w-1/4">
                            <input type="number" value="${val}" onchange="globalCapacities['${camp}'] = Number(this.value)"
                                class="w-full border border-gray-300 rounded px-1 py-1 text-right text-green-700 font-bold outline-none">
                        </div>
                    </div>
                `;
            });
        }

        function exportSettings() {
            let exportData = [];
            Object.entries(globalWeights).forEach(([key, val]) => {
                exportData.push({ "項目類別": "分數權重", "項目名稱": key, "數值": val });
            });
            Object.entries(globalCapacities).forEach(([key, val]) => {
                exportData.push({ "項目類別": "名額上限", "項目名稱": key, "數值": val });
            });
            let vetRatio = document.getElementById('veteran-ratio-input').value;
            exportData.push({ "項目類別": "全域設定", "項目名稱": "老手保障比例(%)", "數值": vetRatio });
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "系統設定");
            XLSX.writeFile(wb, "2026志工媒合系統設定.xlsx");
        }

        function runMatching() {
            try {
                if (globalVolunteers.length === 0) return alert("請先匯入資料！");

                let vetRatioInput = document.getElementById('veteran-ratio-input').value;
                let veteranRatio = Number(vetRatioInput) / 100;
                if(isNaN(veteranRatio) || veteranRatio < 0) veteranRatio = 0.5;

                // 取得各類別的上限
                let limitNewbie = parseInt(document.getElementById('limit-newbie').value) || 2;
                let limitAsusVet = parseInt(document.getElementById('limit-asus-vet').value) || 2;
                let limitNonAsusVet = parseInt(document.getElementById('limit-non-asus-vet').value) || 2;

                let volunteerState = {}; 
                let allApplications = [];

                let timeList = globalVolunteers.map(p => {
                    let timeStr = p[CONFIG.TIMESTAMP];
                    return { name: p[CONFIG.NAME], time: timeStr ? new Date(timeStr).getTime() : Infinity };
                }).filter(item => !isNaN(item.time) && item.time !== Infinity);
                
                timeList.sort((a, b) => a.time - b.time); 

                let earlyBirdScores = {};
                const totalPeople = timeList.length;
                const third = Math.ceil(totalPeople / 3);

                timeList.forEach((item, index) => {
                    let score = 0;
                    let birdType = "";
                    if (index < third) {
                        score = globalWeights["早鳥(前33%)"] || 0;
                        birdType = "早鳥";
                    } else if (index < third * 2) {
                        score = globalWeights["中鳥(中33%)"] || 0;
                        birdType = "中鳥";
                    } else {
                        score = globalWeights["晚鳥(後34%)"] || 0;
                        birdType = "晚鳥";
                    }
                    earlyBirdScores[item.name] = { score: score, type: birdType };
                });

                globalVolunteers.forEach(p => {
                    const pName = p[CONFIG.NAME];
                    volunteerState[pName] = { raw: p, assignedCamps: [], rejectedCamps: [], multiDayCount: 0, tags: [], isVeteran: false };

                    let tags = [];
                    let personalScore = 0;
                    let email = String(p[CONFIG.EMAIL] || "").toLowerCase();
                    let skills = String(p[CONFIG.SKILLS] || "");
                    let exp = String(p[CONFIG.EXPERIENCE] || "");
                    let firstChoiceStr = CONFIG.FIRST_CHOICE ? String(p[CONFIG.FIRST_CHOICE] || "") : "";
                    
                    let isCourseDev = false;
                    if (skills.includes("課程組")) isCourseDev = true;
                    if (CONFIG.COURSE_DEV && String(p[CONFIG.COURSE_DEV] || "").includes("是")) isCourseDev = true;

                    if (isCourseDev) { 
                        tags.push("課程開發"); 
                        personalScore += globalWeights["5.課程開發組"]; 
                    }

                    // 判斷身分類別與年資
                    let isVeteran = false;
                    let userCategory = "newbie"; // newbie, asus-vet, non-asus-vet

                    let isEmployee = email.includes("asus") || !email.includes("gmail") && !email.includes("yahoo") && !email.includes("hotmail"); // 簡易判斷，非免費信箱視為員工 (或依分機號碼)
                    if (email.includes("pegatron")) isEmployee = false; // 和碩算非華碩員工? 這裡暫且歸類為 non-asus

                    if (exp.includes("未曾參加") || exp.includes("無") || exp.includes("未填寫")) {
                        tags.push("年資:新手"); 
                        userCategory = "newbie";
                    } else if (exp.includes("1~2年") || exp === "1年") { 
                        tags.push("年資:1-2年(新手)"); 
                        isVeteran = false; // 邏輯維持：1-2年算新手，不佔老手名額
                        userCategory = "newbie";
                    } else if (exp.includes("2年") || exp.includes("3年") || exp.includes("多次") || exp.includes("以上")) { 
                        tags.push("年資:2年以上(老手)"); 
                        isVeteran = true;
                        
                        // 判斷老手類別
                        if (isEmployee) {
                            userCategory = "asus-vet";
                        } else {
                            userCategory = "non-asus-vet";
                        }
                    } else {
                        tags.push("年資:新手");
                        userCategory = "newbie";
                    }
                    
                    volunteerState[pName].isVeteran = isVeteran;
                    volunteerState[pName].userCategory = userCategory; // 儲存類別以供上限判斷

                    if (email.includes("pegatron") || String(pName).includes("畢業生") || String(pName).includes("和碩")) {
                        tags.push("身分:畢業生/和碩"); personalScore += globalWeights["4.畢業生/和碩生"];
                    }

                    let tData = earlyBirdScores[pName] || { score: 0, type: "無" };
                    if (tData.type) {
                        tags.push(`時間:${tData.type}(+${tData.score})`); 
                        personalScore += tData.score; 
                    }

                    let oneDayCount = 0;
                    CONFIG.CAMPS.forEach(c => {
                        const val = String(p[c]).trim();
                        if (CAMP_DAYS[c] === 1 && (val === "是" || val === "v")) oneDayCount++;
                    });
                    if (oneDayCount > 0) tags.push(`參與${oneDayCount}場一日營`);
                    const oneDayBonus = oneDayCount * globalWeights["2.一日營加分(每場)"];

                    volunteerState[pName].tags = tags;

                    CONFIG.CAMPS.forEach(campName => {
                        const val = String(p[campName]).trim();
                        if (val === "是" || val.toLowerCase() === "true" || val === "v") {
                            
                            const days = CAMP_DAYS[campName];
                            const isMulti = days > 1;
                            const shortName = shortCampName(campName);
                            
                            let datePart = shortName.split(/[\u4e00-\u9fa5]/)[0];
                            let isFirstChoice = firstChoiceStr !== "" && (firstChoiceStr.includes(shortName) || (datePart.length > 3 && firstChoiceStr.includes(datePart)));
                            
                            let rankScore = 0; 
                            let finalOneDayBonus = isMulti ? oneDayBonus : 0;
                            let totalScore = personalScore + rankScore + finalOneDayBonus;

                            let detailStr = `個人分:${personalScore}`;
                            if (isMulti && oneDayBonus > 0) detailStr += ` + 一日營紅利:${oneDayBonus}`;

                            allApplications.push({
                                name: pName,
                                camp: campName,
                                score: totalScore,
                                details: detailStr,
                                tags: tags.join(", "),
                                isFirstChoice: isFirstChoice,
                                isMultiDay: isMulti,
                                isVeteran: isVeteran
                            });
                        }
                    });
                });

                allApplications.sort((a, b) => {
                    if (a.isFirstChoice && !b.isFirstChoice) return -1;
                    if (!a.isFirstChoice && b.isFirstChoice) return 1;
                    return b.score - a.score;
                });

                let currentCounts = {}; 
                let veteranCounts = {}; 
                CONFIG.CAMPS.forEach(c => {
                    currentCounts[c] = 0;
                    veteranCounts[c] = 0;
                });
                
                let finalResults = []; 
                
                allApplications.forEach(app => {
                    const totalLimit = globalCapacities[app.camp] || 25;
                    const pState = volunteerState[app.name];

                    // 關鍵修正 1：一日營隊不檢查個人上限，只有多日營隊才檢查
                    if (app.isMultiDay) {
                        let personalLimit = 2; // 預設
                        if (pState.userCategory === "newbie") personalLimit = limitNewbie;
                        else if (pState.userCategory === "asus-vet") personalLimit = limitAsusVet;
                        else if (pState.userCategory === "non-asus-vet") personalLimit = limitNonAsusVet;

                        if (pState.multiDayCount >= personalLimit) {
                            pState.rejectedCamps.push(app.camp); 
                            return; 
                        }
                    }

                    // 梯次滿額判斷
                    let canAdmit = false;
                    const currentTotal = currentCounts[app.camp];
                    const currentVet = veteranCounts[app.camp];
                    
                    const vetQuota = Math.floor(totalLimit * veteranRatio); 
                    const generalQuota = totalLimit - vetQuota; 
                    const currentGeneral = currentTotal - currentVet;

                    if (currentTotal < totalLimit) {
                        if (app.isVeteran) {
                            if (currentVet < vetQuota) canAdmit = true;
                            else if (currentGeneral < generalQuota) canAdmit = true;
                        } else {
                            if (currentGeneral < generalQuota) canAdmit = true;
                        }
                    }

                    // 關鍵修正 2：如果是一日營隊，且總人數未滿，強制錄取 (不佔老手保障名額，視為一般錄取)
                    // 為了避免一日營隊被老手比例卡住，這裡放寬條件
                    if (!app.isMultiDay && currentTotal < totalLimit) {
                        canAdmit = true;
                    }

                    if (!canAdmit) {
                        pState.rejectedCamps.push(app.camp); 
                        return;
                    }

                    currentCounts[app.camp]++;
                    if(app.isVeteran) veteranCounts[app.camp]++;
                    
                    pState.assignedCamps.push(app.camp);
                    if (app.isMultiDay) pState.multiDayCount++;

                    finalResults.push({
                        name: app.name, tags: app.tags || "一般", bestCamp: app.camp, 
                        totalScore: app.score, details: app.details, 
                        status: "成功", isFirstChoice: app.isFirstChoice,
                        isVeteran: app.isVeteran
                    });
                });

                Object.keys(volunteerState).forEach(vName => {
                    const state = volunteerState[vName];
                    if (state.assignedCamps.length === 0) {
                        // 找出所有被拒絕的申請中分數最高的一個，作為代表顯示在落選區
                    }
                });

                // 重新整理 fullListDisplay 用於顯示
                let fullListDisplay = [];
                Object.keys(volunteerState).forEach(vName => {
                    const state = volunteerState[vName];
                    const raw = state.raw;
                    
                    let app = allApplications.find(a => a.name === vName);
                    let scoreDisplay = app ? app.score : 0;
                    
                    // 3. 抓取志工的所有勾選報名梯次
                    let appliedCamps = [];
                    CONFIG.CAMPS.forEach(c => {
                        const val = String(raw[c]).trim();
                        if (val === "是" || val.toLowerCase() === "true" || val === "v") {
                            appliedCamps.push(shortCampName(c));
                        }
                    });

                    fullListDisplay.push({
                        name: vName,
                        tags: state.tags.join(", "),
                        firstChoice: raw[CONFIG.FIRST_CHOICE] || "無",
                        assigned: state.assignedCamps,
                        rejected: state.rejectedCamps,
                        totalScore: scoreDisplay,
                        isVeteran: state.isVeteran,
                        details: app ? app.details : "無申請",
                        // 新增欄位：所有報名梯次
                        allApplied: appliedCamps
                    });
                });

                fullListDisplay.sort((a, b) => b.totalScore - a.totalScore);

                volunteerAssignmentsMap = volunteerState;
                lastMatchingDataForSearch = fullListDisplay; 

                renderMatchingResults(fullListDisplay);
                renderAllocationOverview(finalResults, currentCounts); 
            } catch (err) {
                alert("執行分發時發生錯誤：" + err.message);
                console.error(err);
            }
        }

        // 修改點: 修復分發結果搜尋邏輯
        function filterMatchingResults() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const filteredData = lastMatchingDataForSearch.filter(item => {
                const name = (item.name || "").toLowerCase();
                const tags = (item.tags || "").toLowerCase();
                return name.includes(input) || tags.includes(input);
            });
            renderMatchingResults(filteredData, true); 
        }

        function renderMatchingResults(data, isFiltering = false) {
            const tbody = document.getElementById('table-matching-list');
            tbody.innerHTML = '';
            
            if(data.length === 0 && isFiltering) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">找不到符合條件的結果</td></tr>`;
                return;
            }

            data.forEach((item, index) => {
                let firstChoiceShort = item.firstChoice;
                if (firstChoiceShort.length > 20) firstChoiceShort = shortCampName(firstChoiceShort);
                if (firstChoiceShort === "無") firstChoiceShort = `<span class="text-gray-400">未填寫</span>`;

                let assignedHtml = item.assigned.length > 0 
                    ? item.assigned.map(c => `<span class="badge-success">${shortCampName(c)}</span>`).join("<br>") 
                    : `<span class="text-gray-400 text-xs">未錄取</span>`;

                let rejectedHtml = item.rejected.length > 0 
                    ? item.rejected.map(c => `<span class="badge-fail">${shortCampName(c)}</span>`).join("<br>") 
                    : `<span class="text-gray-300 text-xs">-</span>`;

                tbody.innerHTML += `
                    <tr class="hover:bg-blue-50 transition border-b">
                        <td class="px-4 py-3 text-gray-500 font-bold">#${index + 1}</td>
                        <td class="px-4 py-3 font-bold text-gray-800 whitespace-nowrap">${item.name}</td>
                        <td class="px-4 py-3 text-xs">
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded leading-relaxed inline-block mb-1">${item.tags}</span>
                            <br><span class="text-gray-400 font-mono">${item.totalScore}分</span>
                        </td>
                        <td class="px-4 py-3 text-xs leading-relaxed text-blue-700 font-medium">${firstChoiceShort}</td>
                        <td class="px-4 py-3 text-xs leading-relaxed">${assignedHtml}</td>
                        <td class="px-4 py-3 text-xs leading-relaxed text-gray-500">${rejectedHtml}</td>
                    </tr>
                `;
            });
            document.getElementById('matching-results-container').classList.remove('hidden');
        }

        function renderAllocationOverview(results, currentCounts) {
            const gridMulti = document.getElementById('allocation-grid-multi');
            const gridSingle = document.getElementById('allocation-grid-single');
            const gridRejected = document.getElementById('allocation-grid-rejected');
            gridMulti.innerHTML = ''; gridSingle.innerHTML = ''; gridRejected.innerHTML = '';

            const grouping = {};
            CONFIG.CAMPS.forEach(c => grouping[c] = []);
            grouping["落選 / 候補"] = [];

            results.forEach(item => {
                if (!grouping[item.bestCamp]) grouping[item.bestCamp] = [];
                grouping[item.bestCamp].push(item);
            });

            let rejectedList = [];
            Object.keys(volunteerAssignmentsMap).forEach(vName => {
                if (volunteerAssignmentsMap[vName].assignedCamps.length === 0) {
                    let rejected = volunteerAssignmentsMap[vName].rejectedCamps.map(shortCampName).join(", ");
                    rejectedList.push({name: vName, totalScore: 0, tags: volunteerAssignmentsMap[vName].tags.join(", "), desc: rejected || "無有效報名"});
                }
            });
            
            Object.entries(grouping).forEach(([campName, list]) => {
                if (campName === "落選 / 候補") return; 

                const count = list.length;
                const limit = globalCapacities[campName] || 0;
                const isMulti = CAMP_DAYS[campName] > 1;
                const cardId = `alloc-${campName.replace(/\W/g, '').substring(0,10)}`;
                const statusText = `${count} / ${limit} 人`;
                
                let vetCountInCard = 0;
                const listHtml = list.map(p => {
                    if (p.isVeteran) vetCountInCard++;
                    return `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100 hover:bg-gray-50 px-2 cursor-pointer" onclick="showVolunteerDetails('${p.name}')">
                            <div class="flex items-center gap-2">
                                 <div class="w-2 h-2 rounded-full ${p.isVeteran ? 'bg-purple-500' : 'bg-blue-500'}"></div>
                                 <span class="font-bold ${p.isVeteran ? 'text-purple-700' : 'text-gray-700'}">${p.name}</span>
                            </div>
                            <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">${p.totalScore}分${p.isFirstChoice?'★':''}</span>
                        </div>
                    `;
                }).join('');

                let subText = `<span class="text-xs text-purple-600 font-bold ml-2">含 ${vetCountInCard} 名老手</span>`;
                const cardHtml = `
                    <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition cursor-pointer group" onclick="toggleAllocation('${cardId}')">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-base text-gray-800 truncate max-w-[200px]" title="${campName}">${shortCampName(campName)}</h4>
                                ${subText}
                            </div>
                            <span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded-full whitespace-nowrap mt-1">${statusText}</span>
                        </div>
                        <div class="text-xs text-gray-400 mb-2 flex items-center">
                            <i class="fa-solid fa-chevron-down mr-1" id="icon-${cardId}"></i> 點擊查看名單
                        </div>
                        <div id="${cardId}" class="allocation-list bg-gray-50 rounded px-2" onclick="event.stopPropagation()">${listHtml}</div>
                    </div>
                `;

                if (isMulti) gridMulti.innerHTML += cardHtml;
                else gridSingle.innerHTML += cardHtml;
            });

            if (rejectedList.length > 0) {
                const rejId = "alloc-rejected";
                const rejHtml = rejectedList.map(p => `
                    <div class="flex justify-between items-center py-2 border-b border-red-100 hover:bg-red-50 px-2 cursor-pointer" onclick="showVolunteerDetails('${p.name}')">
                        <span class="font-bold text-gray-700">${p.name}</span>
                        <span class="text-xs text-red-400 truncate max-w-[150px]">${p.desc}</span>
                    </div>
                `).join('');
                
                gridRejected.innerHTML = `
                    <div class="border rounded-lg p-4 bg-white shadow-sm hover:shadow-md transition cursor-pointer group" onclick="toggleAllocation('${rejId}')">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-base text-red-600">未錄取名單</h4>
                            <span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded-full">${rejectedList.length} 人</span>
                        </div>
                        <div class="text-xs text-gray-400 mb-2 flex items-center"><i class="fa-solid fa-chevron-down mr-1" id="icon-${rejId}"></i> 點擊查看</div>
                        <div id="${rejId}" class="allocation-list bg-gray-50 rounded px-2" onclick="event.stopPropagation()">${rejHtml}</div>
                    </div>
                `;
            } else {
                gridRejected.innerHTML = `<p class="text-sm text-gray-400 p-4">恭喜！所有人都至少錄取了一個梯次。</p>`;
            }

            document.getElementById('allocation-results-container').classList.remove('hidden');
        }

        function toggleAllocation(id) {
            const el = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            if (el.classList.contains('open')) {
                el.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                el.classList.add('open');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        function showVolunteerDetails(name) {
            const state = volunteerAssignmentsMap[name];
            if (!state) return;
            const raw = state.raw;
            document.getElementById('modal-name').innerText = name;
            document.getElementById('modal-tags').innerText = state.tags.join("、") || "無特殊標籤";
            document.getElementById('modal-email').innerText = raw[CONFIG.EMAIL] || "未填寫";
            document.getElementById('modal-exp').innerText = raw[CONFIG.EXPERIENCE] || "未填寫";
            document.getElementById('modal-skills').innerText = raw[CONFIG.SKILLS] || "未填寫";
            document.getElementById('modal-first-choice').innerText = raw[CONFIG.FIRST_CHOICE] || "未填寫";

            const listEl = document.getElementById('modal-camps-list');
            listEl.innerHTML = '';
            let hasCamps = false;
            CONFIG.CAMPS.forEach(c => {
                const val = String(raw[c]).trim();
                if (val === "是" || val.toLowerCase() === "true" || val === "v") {
                    hasCamps = true;
                    const isAssigned = state.assignedCamps.includes(c);
                    const statusBadge = isAssigned ? `<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-0.5 rounded ml-2">已錄取</span>` : `<span class="bg-red-100 text-red-500 text-xs px-2 py-0.5 rounded ml-2">落選/候補</span>`;
                    listEl.innerHTML += `<li class="flex items-start justify-between border-b border-gray-100 py-2 last:border-0"><span class="text-gray-700">${shortCampName(c)}</span>${statusBadge}</li>`;
                }
            });
            if (!hasCamps) listEl.innerHTML = `<li class="text-gray-400 italic">無報名紀錄</li>`;
            
            const modal = document.getElementById('volunteer-modal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div.transform').classList.remove('scale-95');
            modal.querySelector('div.transform').classList.add('scale-100');
            document.body.classList.add('modal-active');
        }

        function closeVolunteerModal() {
            const modal = document.getElementById('volunteer-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div.transform').classList.add('scale-95');
            modal.querySelector('div.transform').classList.remove('scale-100');
            document.body.classList.remove('modal-active');
        }

        function exportMatchingResults() {
            if (globalVolunteers.length === 0) return;
            const exportData = globalVolunteers.map(row => {
                const newRow = { ...row };
                const state = volunteerAssignmentsMap[newRow[CONFIG.NAME]];
                let assignedText = (state && state.assignedCamps.length > 0) ? state.assignedCamps.map(shortCampName).join(" ; ") : "未錄取 / 候補";
                newRow["AI幫你選 (錄取結果)"] = assignedText;

                let rejectedText = (state && state.rejectedCamps.length > 0) ? state.rejectedCamps.map(shortCampName).join(" ; ") : "";
                newRow["落選梯次"] = rejectedText;

                newRow["第一志願(原始)"] = row[CONFIG.FIRST_CHOICE];

                return newRow;
            });
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "分配總表");
            XLSX.writeFile(wb, "2026志工分發總結果(詳細版).xlsx");
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-matching').classList.add('hidden');
            document.getElementById(`view-${tab}`).classList.remove('hidden');
        }

        let charts = {};
        function renderCharts(campData, expData) {
            Object.values(charts).forEach(c => c.destroy());
            Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
            const mapData = (data, limit=0) => {
                let sorted = Object.entries(data).sort((a,b) => b[1]-a[1]);
                if(limit) sorted = sorted.slice(0, limit);
                return { labels: sorted.map(x=>shortCampName(x[0])), values: sorted.map(x=>x[1]) };
            };
            const camps = mapData(campData);
            charts.camps = new Chart(document.getElementById('chart-camps'), { type: 'bar', data: { labels: camps.labels, datasets: [{ data: camps.values, backgroundColor: '#005696', borderRadius:4 }] }, options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: {display:false} } } });
            const exp = mapData(expData);
            charts.exp = new Chart(document.getElementById('chart-experience'), { type: 'doughnut', data: { labels: Object.keys(expData), datasets: [{ data: Object.values(expData), backgroundColor: ['#3b82f6', '#ec4899', '#f59e0b', '#10b981'] }] }, options: { maintainAspectRatio: false } });
        }

        function renderVolunteerList(list) {
            const tbody = document.getElementById('table-top-list');
            // 修改點 4: 完整渲染志工清單
            tbody.innerHTML = list.map((p, i) => {
                // 抓取該志工所有勾選的梯次 (簡化名稱後串接)
                let appliedCamps = [];
                CONFIG.CAMPS.forEach(c => {
                    const val = String(p[c]).trim();
                    if (val === "是" || val.toLowerCase() === "true" || val === "v") {
                        appliedCamps.push(shortCampName(c));
                    }
                });
                let appliedStr = appliedCamps.length > 0 ? appliedCamps.join("、") : "<span class='text-gray-400'>無勾選</span>";

                // 處理第一志願顯示 (縮短)
                let firstChoiceShort = String(p[CONFIG.FIRST_CHOICE] || "未填寫").substring(0, 30);
                if (firstChoiceShort.length > 20) firstChoiceShort = shortCampName(firstChoiceShort);

                return `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="px-6 py-3 font-bold text-gray-500">#${i+1}</td>
                    <td class="px-6 py-3 font-bold text-gray-800 whitespace-nowrap">${p[CONFIG.NAME]}</td>
                    <td class="px-6 py-3 text-xs text-gray-600 leading-relaxed">${appliedStr}</td>
                    <td class="px-6 py-3 text-xs text-blue-700 font-medium">${firstChoiceShort}</td>
                </tr>`;
            }).join('');
        }
    </script>
</body>
</html>
